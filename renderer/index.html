<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="G√©plista QR">
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,ewogICJuYW1lIjogIkfDqXBsaXN0YSBRSDI7IEbcmlzc610xdMSRIiwKICAic2hvcnRfbmFtZSI6ICJHw6lwbGlzdGEgUVIiLAogICJkZXNjcmlwdGlvbiI6ICJRUiBrw7NkIG9sdmFzw6Fzc2FsIGfDqXBsaXN0YSBmcmlzc8OtdMOpcyIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7Y2hhcnNldD11dGYtOCwlM0Nzdmcgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHZpZXdCb3g9JzAgMCAxOTIgMTkyJyBmaWxsPSdub25lJyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzMmMzZTUwJy8lM0UlM0N0ZXh0IHg9Jzk2JyB5PSc5NicgZm9udC1zaXplPSc4MCcgZmlsbD0nJTIzZmZmJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkb21pbmFudC1iYXNlbGluZT0nY2VudHJhbCclM0UlRjAlOUYlOTQlQTclM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    <title>G√©plista QR K√≥d Friss√≠t≈ë</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .file-upload {
            margin-bottom: 25px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .file-input-wrapper:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: scale(1.05);
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            border: 3px solid #3498db;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .equipment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .equipment-table th,
        .equipment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .equipment-table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
        }
        
        .equipment-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .equipment-table tr:hover {
            background-color: #e8f4fd;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .status.error {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .status.info {
            background: linear-gradient(45deg, #cce7ff, #b3d9ff);
            color: #004085;
            border: 2px solid #007bff;
        }
        
        .scanned-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }
        
        .scanned-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        
        .scan-section {
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .scan-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 25px;
            font-size: 1.1em;
            margin-bottom: 25px;
            text-align: center;
            box-sizing: border-box;
        }

        .modal-input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .modal-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .modal-btn:hover {
            background: linear-gradient(45deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .modal-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e74c3c;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #27ae60;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-size: 0.9em;
            font-weight: bold;
            min-width: 60px;
        }

        .toggle-label.active {
            color: #27ae60;
        }

        .toggle-label.inactive {
            color: #e74c3c;
        }

        /* Photo Capture Styles */
        .photo-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .photo-btn:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .photo-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Photo capture modal */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }

        .photo-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }

        .photo-modal video {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            border: 3px solid #3498db;
        }

        .photo-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .capture-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .capture-btn:hover {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .close-photo-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .close-photo-btn:hover {
            background: linear-gradient(45deg, #7f8c8d, #95a5a6);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- N√©vk√≥d bek√©r√©se modal -->
    <div id="nameCodeModal" class="modal">
        <div class="modal-content">
            <h2>üë§ N√©vk√≥d megad√°sa</h2>
            <p>A szkennel√©s elkezd√©se el≈ëtt k√©rlek add meg a n√©vk√≥dod. Ez minden beszkennelt elemhez hozz√°ad√°sra ker√ºl.</p>
            <input type="text" id="nameCodeInput" class="modal-input" placeholder="√çrd be a n√©vk√≥dod (pl: DJ01)" maxlength="10" autocomplete="off">
            <br>
            <button id="confirmNameCode" class="modal-btn" disabled>‚úÖ Folytat√°s</button>
        </div>
    </div>

    <!-- Photo capture modal -->
    <div id="photoModal" class="photo-modal">
        <div class="photo-modal-content">
            <h2>üì∏ Fot√≥ k√©sz√≠t√©se</h2>
            <p id="photoItemName" style="margin-bottom: 15px; font-weight: bold; color: #2c3e50;"></p>
            <video id="photoVideo" autoplay playsinline></video>
            <canvas id="photoCanvas" style="display: none;"></canvas>
            <div class="photo-controls">
                <button id="capturePhotoBtn" class="capture-btn">üì∑ Fot√≥ k√©sz√≠t√©se</button>
                <button id="closePhotoBtn" class="close-photo-btn">‚ùå Bez√°r√°s</button>
            </div>
        </div>
    </div>

    <!-- New Device Modal -->
    <div id="newDeviceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>‚ûï √öj eszk√∂z hozz√°ad√°sa</h2>
            <p style="margin-bottom: 15px; color: #666;">T√∂ltsd ki az √∫j eszk√∂z adatait:</p>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ACSG ID:</label>
                <input type="text" id="newDeviceId" class="modal-input" readonly style="background-color: #f0f0f0;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Gy√°rt√≥ / N√©v:</label>
                <input type="text" id="newDeviceManufacturer" class="modal-input" placeholder="pl: Siemens" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Le√≠r√°s:</label>
                <input type="text" id="newDeviceDescription" class="modal-input" placeholder="pl: CNC megmunk√°l√≥ k√∂zpont">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Modell:</label>
                <input type="text" id="newDeviceModel" class="modal-input" placeholder="pl: DMU 50">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Sorozatsz√°m:</label>
                <input type="text" id="newDeviceSerial" class="modal-input" placeholder="pl: SN123456789">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelNewDevice" class="modal-btn" style="background-color: #6c757d;">‚ùå M√©gse</button>
                <button id="addNewDevice" class="modal-btn">‚úÖ Hozz√°ad</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="globalStatus" class="status" style="display: none; margin: 20px; border-radius: 10px;"></div>
        <div class="header">
            <h1>üîß G√©plista QR K√≥d Friss√≠t≈ë</h1>
            <p>Szkennelj QR k√≥dokat √©s friss√≠tsd a g√©plist√°t egyszer≈±en</p>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h2>üìÅ G√©plista Bet√∂lt√©se</h2>
                <div class="file-upload">
                    <label for="fileInput" class="file-input-wrapper">
                        üìÇ Excel F√°jl Kiv√°laszt√°sa
                        <input type="file" id="fileInput" accept=".xlsx,.xls" />
                    </label>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        üí° <strong>Tipp:</strong> Bet√∂lthetsz eredeti g√©plist√°t vagy kor√°bban let√∂lt√∂tt f√°jlt is - 
                        automatikusan vissza√°ll√≠tja a beszkennelt elemeket!
                    </div>
                </div>
                
                <div id="fileStatus" class="status info" style="display: none;">
                    F√°jl bet√∂ltve sikeresen!
                </div>
                
                <h3>üìä Aktu√°lis G√©plista</h3>
                <div id="equipmentContainer" style="max-height: 300px; overflow-y: auto;">
                    <p>T√∂lts be egy Excel f√°jlt a lista megtekint√©s√©hez</p>
                </div>
            </div>
            
            <div class="panel">
                <h2>üì± QR K√≥d Beolvas√°s</h2>
                
                <!-- Kamera szkenner -->
                <div class="scan-section">
                    <h3>üì∑ Kamer√°s Szkenner (HTTPS sz√ºks√©ges)</h3>
                    <div class="controls">
                        <button id="startScan" class="btn">üì∑ Szkenner Ind√≠t√°sa</button>
                        <button id="stopScan" class="btn secondary" disabled>‚èπÔ∏è Szkenner Le√°ll√≠t√°sa</button>
                    </div>
                    <video id="video" style="display: none;"></video>
                </div>

                <!-- Manu√°lis bevitel -->
                <div class="scan-section" style="margin-top: 25px;">
                    <h3>‚úèÔ∏è Manu√°lis ACSG ID Bevitel</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="manualInput" placeholder="√çrj be ACSG ID-t (pl: AU2219)" 
                               style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #3498db; border-radius: 25px; font-size: 1em;">
                        <button id="addManual" class="btn">‚ûï Hozz√°ad√°s</button>
                    </div>
                </div>

                <!-- K√©p felt√∂lt√©ses QR olvas√°s -->
                <div class="scan-section" style="margin-top: 25px;">
                    <h3>üñºÔ∏è QR K√©p Felt√∂lt√©se</h3>
                    <label for="qrImageInput" class="file-input-wrapper" style="display: inline-block; margin: 0;">
                        üì∏ QR K√©p Kiv√°laszt√°sa
                        <input type="file" id="qrImageInput" accept="image/*" />
                    </label>
                    <div id="imagePreview" style="margin-top: 15px; display: none;">
                        <img id="previewImg" style="max-width: 200px; border-radius: 10px; border: 2px solid #3498db;">
                    </div>
                </div>
                
                <div id="scanStatus" class="status info" style="display: none;">
                    V√°lassz egy m√≥dszert a QR k√≥dok beolvas√°s√°hoz
                </div>
                
                <h3>‚úÖ Beszkennelt Elemek</h3>
                <div id="scannedList" class="scanned-list">
                    <p style="text-align: center; color: #666; font-style: italic;">
                        M√©g nem szkennelt√©l be egyetlen elemet sem
                    </p>
                </div>
            </div>
        </div>
        
            <div class="panel" style="margin: 30px; margin-top: 0;">
            <h2>üíæ Friss√≠tett Lista Let√∂lt√©se</h2>
            <p style="margin-bottom: 15px; color: #666;">
                A let√∂lt√∂tt f√°jl tartalmazza az √∂sszes beszkennelt inform√°ci√≥t. 
                K√©s≈ëbb visszat√∂ltve folytathatod ugyanott, ahol abbahagytad! üîÑ
            </p>
            <div class="controls">
                <button id="downloadExcel" class="btn">‚¨áÔ∏è Excel Let√∂lt√©se</button>
                <button id="clearScanned" class="btn secondary">üóëÔ∏è Beszkennelt Lista T√∂rl√©se</button>
            </div>
            <div id="downloadStatus" class="status info" style="display: none;">
                Kattints a "Excel Let√∂lt√©se" gombra a friss√≠tett f√°jl let√∂lt√©s√©hez
            </div>
        </div>
    </div>

    <script>
        let equipmentData = [];
        let scannedItems = [];
        let qrScanner = null;
        let isScanning = false;
        let userNameCode = '';

        // DOM elemek
        const fileInput = document.getElementById('fileInput');
        const startScanBtn = document.getElementById('startScan');
        const stopScanBtn = document.getElementById('stopScan');
        const video = document.getElementById('video');
        const manualInput = document.getElementById('manualInput');
        const addManualBtn = document.getElementById('addManual');
        const qrImageInput = document.getElementById('qrImageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const equipmentContainer = document.getElementById('equipmentContainer');
        const scannedList = document.getElementById('scannedList');
        const downloadExcelBtn = document.getElementById('downloadExcel');
        const clearScannedBtn = document.getElementById('clearScanned');

        // Modal elemek
        const nameCodeModal = document.getElementById('nameCodeModal');
        const nameCodeInput = document.getElementById('nameCodeInput');
        const confirmNameCodeBtn = document.getElementById('confirmNameCode');

        // Photo capture elemek
        const photoModal = document.getElementById('photoModal');
        const photoVideo = document.getElementById('photoVideo');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const closePhotoBtn = document.getElementById('closePhotoBtn');
        const photoItemName = document.getElementById('photoItemName');

        // St√°tusz elemek
        const globalStatus = document.getElementById('globalStatus');
        const fileStatus = document.getElementById('fileStatus');
        const scanStatus = document.getElementById('scanStatus');
        const downloadStatus = document.getElementById('downloadStatus');

        // Event listener-ek
        fileInput.addEventListener('change', handleFileLoad);
        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);
        addManualBtn.addEventListener('click', addManualCode);
        manualInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualCode();
            }
        });
        qrImageInput.addEventListener('change', handleImageUpload);
        downloadExcelBtn.addEventListener('click', downloadExcel);
        clearScannedBtn.addEventListener('click', clearScanned);

        // Modal event listener-ek
        nameCodeInput.addEventListener('input', validateNameCode);
        nameCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !confirmNameCodeBtn.disabled) {
                confirmNameCode();
            }
        });
        confirmNameCodeBtn.addEventListener('click', confirmNameCode);

        // Photo capture event listener-ek
        capturePhotoBtn.addEventListener('click', capturePhoto);
        closePhotoBtn.addEventListener('click', closePhotoModal);

        // N√©vk√≥d modal kezel≈ë f√ºggv√©nyek
        function validateNameCode() {
            const code = nameCodeInput.value.trim().toUpperCase();
            confirmNameCodeBtn.disabled = code.length < 2;
            nameCodeInput.value = code;
        }

        function confirmNameCode() {
            const code = nameCodeInput.value.trim().toUpperCase();
            if (code.length >= 2) {
                userNameCode = code;
                nameCodeModal.style.display = 'none';
                showGlobalInfo(`üìù N√©vk√≥d be√°ll√≠tva: ${userNameCode}`);
            }
        }

        function showNameCodeModal() {
            nameCodeModal.style.display = 'block';
            nameCodeInput.focus();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Fejl√©c elemz√©se - ellen≈ërizz√ºk hogy ez egy kor√°bban export√°lt f√°jl-e
                    const headers = jsonData[0];
                    const hasScannedColumn = headers.some(header => 
                        header && header.toString().toLowerCase().includes('scanned')
                    );
                    const hasScannedAtColumn = headers.some(header => 
                        header && (header.toString().toLowerCase().includes('scanned at') || 
                                  header.toString().toLowerCase().includes('scanned_at'))
                    );
                    const hasSourceColumn = headers.some(header =>
                        header && header.toString().toLowerCase().includes('source')
                    );
                    const hasNameCodeColumn = headers.some(header =>
                        header && header.toString().toLowerCase().includes('name code')
                    );
                    const hasActiveColumn = headers.some(header =>
                        header && header.toString().toLowerCase().includes('active')
                    );

                    let scannedColumnIndex = -1;
                    let scannedAtColumnIndex = -1;
                    let sourceColumnIndex = -1;
                    let nameCodeColumnIndex = -1;
                    let activeColumnIndex = -1;

                    if (hasScannedColumn) {
                        scannedColumnIndex = headers.findIndex(header => 
                            header && header.toString().toLowerCase().includes('scanned') && 
                            !header.toString().toLowerCase().includes('at')
                        );
                    }

                    if (hasScannedAtColumn) {
                        scannedAtColumnIndex = headers.findIndex(header => 
                            header && (header.toString().toLowerCase().includes('scanned at') || 
                                      header.toString().toLowerCase().includes('scanned_at'))
                        );
                    }

                    if (hasSourceColumn) {
                        sourceColumnIndex = headers.findIndex(header =>
                            header && header.toString().toLowerCase().includes('source')
                        );
                    }

                    if (hasNameCodeColumn) {
                        nameCodeColumnIndex = headers.findIndex(header =>
                            header && header.toString().toLowerCase().includes('name code')
                        );
                    }

                    if (hasActiveColumn) {
                        activeColumnIndex = headers.findIndex(header =>
                            header && header.toString().toLowerCase().includes('active')
                        );
                    }

                    // Adatok feldolgoz√°sa
                    equipmentData = [];
                    scannedItems = []; // Beszkennelt lista t√∂rl√©se
                    
                    let restoredCount = 0;

                    jsonData.slice(1).forEach((row, index) => {
                        const item = {
                            id: index + 1,
                            manufacturer: row[0] || '',
                            description: row[1] || '',
                            model: row[2] || '',
                            serialNumber: row[3] || '',
                            acsgId: row[4] || '',
                            scanned: false,
                            scannedAt: null,
                            source: null,
                            nameCode: null,
                            active: true, // Default to active
                            hasPhoto: false // Default no photo
                        };

                        // Ha van Scanned oszlop, akkor vissza√°ll√≠tjuk az √°llapotot
                        if (scannedColumnIndex !== -1 && row[scannedColumnIndex]) {
                            const scannedValue = row[scannedColumnIndex].toString().toLowerCase();
                            if (scannedValue === 'yes' || scannedValue === 'igen' || scannedValue === '1' || scannedValue === 'true') {
                                item.scanned = true;
                                restoredCount++;
                                
                                // Scanned At vissza√°ll√≠t√°sa
                                if (scannedAtColumnIndex !== -1 && row[scannedAtColumnIndex]) {
                                    item.scannedAt = row[scannedAtColumnIndex];
                                }
                                
                                // Source vissza√°ll√≠t√°sa
                                if (sourceColumnIndex !== -1 && row[sourceColumnIndex]) {
                                    item.source = row[sourceColumnIndex];
                                } else {
                                    item.source = 'Kor√°bban r√∂gz√≠tve';
                                }

                                // Name Code vissza√°ll√≠t√°sa
                                if (nameCodeColumnIndex !== -1 && row[nameCodeColumnIndex]) {
                                    item.nameCode = row[nameCodeColumnIndex];
                                }

                                // Hozz√°ad√°s a beszkennelt list√°hoz
                                scannedItems.push({...item});
                            }
                        }

                        // Active √°llapot vissza√°ll√≠t√°sa (minden itemre, nemcsak a scannedre)
                        if (activeColumnIndex !== -1 && row[activeColumnIndex]) {
                            const activeValue = row[activeColumnIndex].toString().toLowerCase();
                            item.active = (activeValue === 'yes' || activeValue === 'igen' || activeValue === '1' || activeValue === 'true');
                        }

                        equipmentData.push(item);
                    });

                    displayEquipmentList();
                    displayScannedList();

                    // F√≥kusz vissza√°ll√≠t√°sa a manu√°lis beviteli mez≈ëre
                    setTimeout(() => {
                        manualInput.focus();
                    }, 100);

                    let statusMessage = `${equipmentData.length} g√©p bet√∂ltve sikeresen!`;
                    if (restoredCount > 0) {
                        statusMessage += ` üîÑ ${restoredCount} kor√°bban beszkennelt elem vissza√°ll√≠tva!`;
                        showStatus(fileStatus, statusMessage, 'success');
                        showStatus(scanStatus, `‚úÖ Folytathatod a munk√°t! ${restoredCount} elem m√°r be volt szkennelve.`, 'success');
                    } else {
                        showStatus(fileStatus, statusMessage, 'success');
                    }
                    
                } catch (error) {
                    showGlobalError('Hiba a f√°jl bet√∂lt√©sekor: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayEquipmentList() {
            if (equipmentData.length === 0) {
                equipmentContainer.innerHTML = '<p>Nincs bet√∂lt√∂tt adat</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'equipment-table';
            
            // Fejl√©c
            const headerRow = document.createElement('tr');
            ['Gy√°rt√≥', 'Modell', 'Le√≠r√°s', 'ACSG ID', 'St√°tusz'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Adatok
            equipmentData.forEach(item => {
                const row = document.createElement('tr');
                
                [item.manufacturer, item.model, item.description, item.acsgId].forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    row.appendChild(td);
                });

                const statusTd = document.createElement('td');
                if (item.scanned) {
                    statusTd.innerHTML = `<span style="color: green; font-weight: bold;">‚úÖ Beszkennelve</span>
                                        <br><small style="color: #666;">${item.scannedAt || 'Ismeretlen id≈ëpont'}</small>`;
                } else {
                    statusTd.innerHTML = '<span style="color: #999;">‚è≥ V√°rakozik</span>';
                }
                row.appendChild(statusTd);

                if (item.scanned) {
                    row.style.backgroundColor = '#d4edda';
                }

                table.appendChild(row);
            });

            equipmentContainer.innerHTML = '';
            equipmentContainer.appendChild(table);
        }

        // QR szkenner funkci√≥k
        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);

        async function startScanning() {
            try {
                // HTTPS ellen≈ërz√©s
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    showGlobalError('‚ö†Ô∏è HTTPS sz√ºks√©ges a kamera haszn√°lat√°hoz! Haszn√°ld a manu√°lis bevitelt vagy k√©p felt√∂lt√©st.');
                    return;
                }

                if (!QrScanner.hasCamera()) {
                    showGlobalError('Nincs el√©rhet≈ë kamera! Haszn√°ld a manu√°lis bevitelt.');
                    return;
                }

                video.style.display = 'block';
                qrScanner = new QrScanner(video, handleQrResult, {
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                });

                await qrScanner.start();
                isScanning = true;
                startScanBtn.disabled = true;
                stopScanBtn.disabled = false;
                showStatus(scanStatus, 'Szkenner akt√≠v - ir√°ny√≠tsd a kamer√°t egy QR k√≥dra', 'info');

            } catch (error) {
                showGlobalError('Hiba a szkenner ind√≠t√°sakor: ' + error.message + '. Haszn√°ld a manu√°lis bevitelt!');
            }
        }

        function stopScanning() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner = null;
            }
            video.style.display = 'none';
            isScanning = false;
            startScanBtn.disabled = false;
            stopScanBtn.disabled = true;
            showStatus(scanStatus, 'Szkenner le√°ll√≠tva', 'success');
        }

        function handleQrResult(result) {
            const scannedCode = result.data;
            processScannedCode(scannedCode, 'Kamer√°s szkenner');
        }

        // Manu√°lis k√≥d hozz√°ad√°sa
        function addManualCode() {
            const code = manualInput.value.trim().toUpperCase().replace(/√ñ/g, '0');
            if (!code) {
                showStatus(scanStatus, 'K√©rlek √≠rj be egy ACSG ID-t!', 'error');
                manualInput.focus(); // F√≥kusz visszaad√°sa
                return;
            }

            processScannedCode(code, 'Manu√°lis bevitel');
            manualInput.value = '';
            manualInput.focus(); // F√≥kusz visszaad√°sa a k√∂vetkez≈ë beolvas√°shoz
        }

        // K√©p felt√∂lt√©s √©s QR olvas√°s
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // K√©p el≈ën√©zet
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                
                // QR k√≥d olvas√°s a k√©pb≈ël
                QrScanner.scanImage(file, { returnDetailedScanResult: true })
                    .then(result => {
                        processScannedCode(result.data, 'K√©p felt√∂lt√©s');
                        showStatus(scanStatus, `‚úÖ QR k√≥d sikeresen beolvasva a k√©pb≈ël!`, 'success');
                    })
                    .catch(error => {
                        showStatus(scanStatus, '‚ùå Nem siker√ºlt QR k√≥dot tal√°lni a k√©pben. Pr√≥b√°ld a manu√°lis bevitelt!', 'error');
                        console.log('QR olvas√°si hiba:', error);
                    });
            };
            reader.readAsDataURL(file);
        }

        // K√∂zponti k√≥d feldolgoz√°s
        function processScannedCode(scannedCode, source) {
            // Keres√©s az equipment list√°ban
            const foundItem = equipmentData.find(item =>
                item.acsgId.toUpperCase() === scannedCode.toUpperCase()
            );

            if (foundItem) {
                if (!foundItem.scanned) {
                    foundItem.scanned = true;
                    foundItem.scannedAt = new Date().toLocaleString('hu-HU');
                    foundItem.source = source;
                    foundItem.nameCode = userNameCode;
                    foundItem.active = true; // Default to active
                    foundItem.hasPhoto = false; // Default no photo

                    // Hozz√°ad√°s a beszkennelt list√°hoz
                    if (!scannedItems.find(item => item.acsgId.toUpperCase() === scannedCode.toUpperCase())) {
                        scannedItems.push({...foundItem});
                        displayScannedList();
                        displayEquipmentList(); // Lista friss√≠t√©se
                        showStatus(scanStatus, `‚úÖ Sikeres szkennel√©s (${source}): ${foundItem.manufacturer} ${foundItem.model}`, 'success');
                    } else {
                        showStatus(scanStatus, `‚ö†Ô∏è Ez az elem m√°r be volt szkennelve: ${foundItem.manufacturer} ${foundItem.model}`, 'info');
                    }
                } else {
                    showStatus(scanStatus, `‚ö†Ô∏è Ez az elem m√°r be volt szkennelve kor√°bban`, 'info');
                }
            } else {
                // Ismeretlen ID eset√©n felhaszn√°l√≥ v√°laszt√°sa
                if (confirm(`‚ùì Ismeretlen ACSG ID: ${scannedCode}\n\nSzeretn√©d felvenni √∫j eszk√∂zk√©nt?`)) {
                    showNewDeviceModal(scannedCode);
                } else {
                    showStatus(scanStatus, `‚ùå Ismeretlen ACSG ID: ${scannedCode}. Ellen≈ërizd a k√≥dot!`, 'error');
                }
            }
        }

        function displayScannedList() {
            if (scannedItems.length === 0) {
                scannedList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">M√©g nem szkennelt√©l be egyetlen elemet sem</p>';
                return;
            }

            const container = document.createElement('div');
            scannedItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'scanned-item';
                const isActive = item.active !== false; // Default to true if not set
                itemDiv.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${item.manufacturer} ${item.model}</strong><br>
                        ${item.description ? `<small>Le√≠r√°s: ${item.description}</small><br>` : ''}
                        <small>ACSG ID: ${item.acsgId}</small><br>
                        ${item.serialNumber ? `<small>Sorozatsz√°m: ${item.serialNumber}</small><br>` : ''}
                        <small>Forr√°s: ${item.source || 'Ismeretlen'}</small><br>
                        <small>Id≈ëpont: ${item.scannedAt}</small>
                        <div class="toggle-container">
                            <span class="toggle-label ${isActive ? 'active' : 'inactive'}" id="toggleLabel${index}">
                                ${isActive ? 'Akt√≠v' : 'Inakt√≠v'}
                            </span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleActiveState(${index})" id="toggle${index}">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                        <button onclick="takePhoto(${index})" class="photo-btn" title="Fot√≥ k√©sz√≠t√©se">
                            üì∏ ${item.hasPhoto ? '‚úÖ' : 'Fot√≥'}
                        </button>
                        <button onclick="removeScannedItem(${index})" class="btn secondary" style="padding: 5px 10px; font-size: 0.8em;">‚ùå</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            scannedList.innerHTML = '';
            scannedList.appendChild(container);
        }

        // Photo capture v√°ltoz√≥k
        let currentPhotoItemIndex = -1;
        let photoStream = null;

        // Fot√≥ k√©sz√≠t√©se egy elemr≈ël
        function takePhoto(index) {
            if (index >= 0 && index < scannedItems.length) {
                currentPhotoItemIndex = index;
                const item = scannedItems[index];
                photoItemName.textContent = `${item.manufacturer} ${item.model} (${item.acsgId})`;
                showPhotoModal();
            }
        }

        // Photo modal megjelen√≠t√©se √©s kamera ind√≠t√°sa
        async function showPhotoModal() {
            photoModal.style.display = 'block';

            try {
                // Kamera stream ind√≠t√°sa
                photoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // H√°ts√≥ kamera el≈ënyben r√©szes√≠t√©se
                    }
                });
                photoVideo.srcObject = photoStream;
                capturePhotoBtn.disabled = false;
            } catch (error) {
                console.error('Kamera hozz√°f√©r√©si hiba:', error);
                showStatus(scanStatus, 'Kamera hozz√°f√©r√©si hiba! Ellen≈ërizd az enged√©lyeket.', 'error');
                closePhotoModal();
            }
        }

        // Photo modal bez√°r√°sa
        function closePhotoModal() {
            photoModal.style.display = 'none';

            // Kamera stream le√°ll√≠t√°sa
            if (photoStream) {
                photoStream.getTracks().forEach(track => track.stop());
                photoStream = null;
            }

            photoVideo.srcObject = null;
            capturePhotoBtn.disabled = true;
            currentPhotoItemIndex = -1;
        }

        // Fot√≥ k√©sz√≠t√©se √©s let√∂lt√©se
        function capturePhoto() {
            if (currentPhotoItemIndex < 0 || !photoStream) return;

            const item = scannedItems[currentPhotoItemIndex];

            // Canvas be√°ll√≠t√°sa a vide√≥ m√©ret√©hez
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = photoVideo.videoWidth;
            photoCanvas.height = photoVideo.videoHeight;

            // Vide√≥ frame r√∂gz√≠t√©se canvas-ra
            context.drawImage(photoVideo, 0, 0);

            // Canvas konvert√°l√°sa blob-ba
            photoCanvas.toBlob(function(blob) {
                // Let√∂lt√©s ind√≠t√°sa
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${item.acsgId}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Fot√≥ st√°tusz friss√≠t√©se
                item.hasPhoto = true;
                const equipmentItem = equipmentData.find(eq => eq.acsgId === item.acsgId);
                if (equipmentItem) {
                    equipmentItem.hasPhoto = true;
                }

                // Lista friss√≠t√©se hogy megjelenjen a fot√≥ indik√°tor
                displayScannedList();

                showStatus(scanStatus, `üì∏ Fot√≥ k√©sz√≠tve √©s let√∂ltve: ${item.acsgId}.jpg`, 'success');
                closePhotoModal();
            }, 'image/jpeg', 0.8);
        }

        // Akt√≠v/Inakt√≠v √°llapot v√°lt√°sa
        function toggleActiveState(index) {
            if (index >= 0 && index < scannedItems.length) {
                const item = scannedItems[index];
                item.active = !item.active;

                // Friss√≠t√©s a f≈ë equipment list√°ban is
                const equipmentItem = equipmentData.find(eq => eq.acsgId === item.acsgId);
                if (equipmentItem) {
                    equipmentItem.active = item.active;
                }

                // Label friss√≠t√©se
                const label = document.getElementById(`toggleLabel${index}`);
                if (label) {
                    label.textContent = item.active ? 'Akt√≠v' : 'Inakt√≠v';
                    label.className = `toggle-label ${item.active ? 'active' : 'inactive'}`;
                }

                showStatus(scanStatus, `${item.manufacturer} ${item.model} √°llapota: ${item.active ? 'Akt√≠v' : 'Inakt√≠v'}`, 'info');
            }
        }

        function removeScannedItem(index) {
            const item = scannedItems[index];
            
            // Jel√∂l√©s visszavon√°sa az eredeti list√°ban
            const originalItem = equipmentData.find(eq => eq.acsgId === item.acsgId);
            if (originalItem) {
                originalItem.scanned = false;
                originalItem.scannedAt = null;
            }
            
            scannedItems.splice(index, 1);
            displayScannedList();
            displayEquipmentList();
        }

        // Let√∂lt√©s √©s t√∂rl√©s event listener-ek
        downloadExcelBtn.addEventListener('click', downloadExcel);
        clearScannedBtn.addEventListener('click', clearScanned);

        function downloadExcel() {
            if (equipmentData.length === 0) {
                showStatus(downloadStatus, 'Nincs adat a let√∂lt√©shez!', 'error');
                return;
            }

            try {
                // √öj munkaf√ºzet l√©trehoz√°sa
                const wb = XLSX.utils.book_new();
                
                // Adatok el≈ëk√©sz√≠t√©se
                const wsData = [
                    ['Manufacturer', 'Description', 'Model', 'Serial Number', 'ACSG ID (ABAS ID)', 'Scanned', 'Scanned At', 'Source', 'Name Code', 'Active']
                ];

                equipmentData.forEach(item => {
                    wsData.push([
                        item.manufacturer,
                        item.description,
                        item.model,
                        item.serialNumber || '',
                        item.acsgId,
                        item.scanned ? 'Yes' : 'No',
                        item.scannedAt || '',
                        item.source || '',
                        item.nameCode || '',
                        item.scanned ? (item.active !== false ? 'Yes' : 'No') : '' // Only show active state for scanned items
                    ]);
                });

                // Munkalap l√©trehoz√°sa
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'upkeep-assets');

                // F√°jl let√∂lt√©se
                const fileName = `G√©plista_friss√≠tve_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus(downloadStatus, `Excel f√°jl let√∂ltve: ${fileName}`, 'success');
                
            } catch (error) {
                showGlobalError('Hiba a let√∂lt√©s sor√°n: ' + error.message);
            }
        }

        function clearScanned() {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d az √∂sszes beszkennelt elemet? Ez a m≈±velet nem vonhat√≥ vissza.')) {
                scannedItems = [];
                equipmentData.forEach(item => {
                    item.scanned = false;
                    item.scannedAt = null;
                    item.source = null;
                });
                displayScannedList();
                displayEquipmentList();
                showStatus(downloadStatus, 'Beszkennelt lista t√∂r√∂lve', 'success');
            }
        }

        function showStatus(element, message, type, isGlobal = false) {
            // Ha glob√°lis st√°tusz, akkor a tetej√©re helyezz√ºk
            const targetElement = isGlobal ? globalStatus : element;

            targetElement.textContent = message;
            targetElement.className = `status ${type}`;
            targetElement.style.display = 'block';

            // Glob√°lis √ºzenetn√©l g√∂rgess√ºnk fel
            if (isGlobal) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            setTimeout(() => {
                targetElement.style.display = 'none';
            }, 5000);
        }

        // Glob√°lis hiba√ºzenet megjelen√≠t√©s
        function showGlobalError(message) {
            showStatus(null, message, 'error', true);
        }

        function showGlobalSuccess(message) {
            showStatus(null, message, 'success', true);
        }

        function showGlobalInfo(message) {
            showStatus(null, message, 'info', true);
        }

        // Oldal bet√∂lt√©skor
        document.addEventListener('DOMContentLoaded', function() {
            // N√©vk√≥d bek√©r√©se modal megjelen√≠t√©se
            showNameCodeModal();

            showStatus(scanStatus, 'V√°lassz egy m√≥dszert a QR k√≥dok beolvas√°s√°hoz! üì±üíªüì∑', 'info');

            // F√≥kusz a manu√°lis beviteli mez≈ëre (csak ha nincs akt√≠v modal)
            if (nameCodeModal.style.display === 'none') {
                manualInput.focus();
            }

            // HTTPS figyelmeztet√©s megjelen√≠t√©se ha sz√ºks√©ges
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                setTimeout(() => {
                    showStatus(scanStatus, 'üí° Tipp: HTTPS-en a kamer√°s szkenner is haszn√°lhat√≥!', 'info');
                }, 3000);
            }

            // PWA telep√≠t√©s t√°mogat√°sa
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Telep√≠t√©s gomb megjelen√≠t√©se
                const installBtn = document.createElement('button');
                installBtn.className = 'btn';
                installBtn.innerHTML = 'üì± Telep√≠t√©s Android App-k√©nt';
                installBtn.style.position = 'fixed';
                installBtn.style.bottom = '20px';
                installBtn.style.right = '20px';
                installBtn.style.zIndex = '1000';
                installBtn.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
                
                installBtn.onclick = async () => {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('PWA telep√≠tve');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                };
                
                document.body.appendChild(installBtn);
            });
        });

        // New Device Modal functionality
        const newDeviceModal = document.getElementById('newDeviceModal');
        const newDeviceIdInput = document.getElementById('newDeviceId');
        const newDeviceManufacturerInput = document.getElementById('newDeviceManufacturer');
        const newDeviceDescriptionInput = document.getElementById('newDeviceDescription');
        const newDeviceModelInput = document.getElementById('newDeviceModel');
        const newDeviceSerialInput = document.getElementById('newDeviceSerial');
        const cancelNewDeviceBtn = document.getElementById('cancelNewDevice');
        const addNewDeviceBtn = document.getElementById('addNewDevice');

        function showNewDeviceModal(scannedCode) {
            newDeviceIdInput.value = scannedCode;
            newDeviceManufacturerInput.value = '';
            newDeviceDescriptionInput.value = '';
            newDeviceModelInput.value = '';
            newDeviceSerialInput.value = '';
            newDeviceModal.style.display = 'flex';
            setTimeout(() => {
                newDeviceManufacturerInput.focus();
            }, 100);
        }

        function closeNewDeviceModal() {
            newDeviceModal.style.display = 'none';
        }

        function addNewDevice() {
            const manufacturer = newDeviceManufacturerInput.value.trim();
            const description = newDeviceDescriptionInput.value.trim();
            const model = newDeviceModelInput.value.trim();
            const serialNumber = newDeviceSerialInput.value.trim();
            const acsgId = newDeviceIdInput.value.trim();

            if (!manufacturer) {
                alert('A gy√°rt√≥/n√©v mez≈ë kit√∂lt√©se k√∂telez≈ë!');
                newDeviceManufacturerInput.focus();
                return;
            }

            if (!acsgId) {
                alert('ACSG ID hi√°nyzik!');
                return;
            }

            // Check if ACSG ID already exists
            const existingItem = equipmentData.find(item =>
                item.acsgId.toUpperCase() === acsgId.toUpperCase()
            );

            if (existingItem) {
                alert('Ez az ACSG ID m√°r l√©tezik a list√°ban!');
                return;
            }

            // Create new device item
            const newItem = {
                id: equipmentData.length + 1,
                manufacturer: manufacturer,
                description: description,
                model: model,
                serialNumber: serialNumber,
                acsgId: acsgId,
                scanned: true, // Automatically mark as scanned
                scannedAt: new Date().toLocaleString('hu-HU'),
                source: '√öj eszk√∂z hozz√°ad√°sa',
                nameCode: userNameCode,
                active: true,
                hasPhoto: false
            };

            // Add to equipment data
            equipmentData.push(newItem);

            // Add to scanned items
            scannedItems.push({...newItem});

            // Update displays
            displayEquipmentList();
            displayScannedList();

            // Close modal
            closeNewDeviceModal();

            // Show success message
            showStatus(scanStatus, `‚úÖ √öj eszk√∂z hozz√°adva √©s beszkennelve: ${manufacturer} ${model}`, 'success');
        }

        // Event listeners for new device modal
        cancelNewDeviceBtn.addEventListener('click', closeNewDeviceModal);
        addNewDeviceBtn.addEventListener('click', addNewDevice);

        // Close modal when clicking outside
        newDeviceModal.addEventListener('click', function(e) {
            if (e.target === newDeviceModal) {
                closeNewDeviceModal();
            }
        });

        // Handle Enter key in form fields
        [newDeviceManufacturerInput, newDeviceDescriptionInput, newDeviceModelInput, newDeviceSerialInput].forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewDevice();
                }
            });
        });
    </script>
</body>
</html>
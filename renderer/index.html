<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Géplista QR">
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,ewogICJuYW1lIjogIkfDqXBsaXN0YSBRSDI7IEbcmlzc610xdMSRIiwKICAic2hvcnRfbmFtZSI6ICJHw6lwbGlzdGEgUVIiLAogICJkZXNjcmlwdGlvbiI6ICJRUiBrw7NkIG9sdmFzw6Fzc2FsIGfDqXBsaXN0YSBmcmlzc8OtdMOpcyIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7Y2hhcnNldD11dGYtOCwlM0Nzdmcgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHZpZXdCb3g9JzAgMCAxOTIgMTkyJyBmaWxsPSdub25lJyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzMmMzZTUwJy8lM0UlM0N0ZXh0IHg9Jzk2JyB5PSc5NicgZm9udC1zaXplPSc4MCcgZmlsbD0nJTIzZmZmJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkb21pbmFudC1iYXNlbGluZT0nY2VudHJhbCclM0UlRjAlOUYlOTQlQTclM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    <title>Géplista QR Kód Frissítő</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .file-upload {
            margin-bottom: 25px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .file-input-wrapper:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: scale(1.05);
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            border: 3px solid #3498db;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .equipment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .equipment-table th,
        .equipment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .equipment-table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
        }
        
        .equipment-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .equipment-table tr:hover {
            background-color: #e8f4fd;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .status.error {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .status.info {
            background: linear-gradient(45deg, #cce7ff, #b3d9ff);
            color: #004085;
            border: 2px solid #007bff;
        }
        
        .scanned-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }
        
        .scanned-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        
        .scan-section {
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .scan-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 25px;
            font-size: 1.1em;
            margin-bottom: 25px;
            text-align: center;
            box-sizing: border-box;
        }

        .modal-input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .modal-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .modal-btn:hover {
            background: linear-gradient(45deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .modal-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e74c3c;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #27ae60;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-size: 0.9em;
            font-weight: bold;
            min-width: 60px;
        }

        .toggle-label.active {
            color: #27ae60;
        }

        .toggle-label.inactive {
            color: #e74c3c;
        }

        /* Photo Capture Styles */
        .photo-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .photo-btn:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .photo-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Photo capture modal */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }

        .photo-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }

        .photo-modal video {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            border: 3px solid #3498db;
        }

        .photo-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .capture-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .capture-btn:hover {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .close-photo-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .close-photo-btn:hover {
            background: linear-gradient(45deg, #7f8c8d, #95a5a6);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Névkód bekérése modal -->
    <div id="nameCodeModal" class="modal">
        <div class="modal-content">
            <h2>👤 Névkód megadása</h2>
            <p>A szkennelés elkezdése előtt kérlek add meg a névkódod. Ez minden beszkennelt elemhez hozzáadásra kerül.</p>
            <input type="text" id="nameCodeInput" class="modal-input" placeholder="Írd be a névkódod (pl: DJ01)" maxlength="10" autocomplete="off">
            <br>
            <button id="confirmNameCode" class="modal-btn" disabled>✅ Folytatás</button>
        </div>
    </div>

    <!-- Photo capture modal -->
    <div id="photoModal" class="photo-modal">
        <div class="photo-modal-content">
            <h2>📸 Fotó készítése</h2>
            <p id="photoItemName" style="margin-bottom: 15px; font-weight: bold; color: #2c3e50;"></p>
            <video id="photoVideo" autoplay playsinline></video>
            <canvas id="photoCanvas" style="display: none;"></canvas>
            <div class="photo-controls">
                <button id="capturePhotoBtn" class="capture-btn">📷 Fotó készítése</button>
                <button id="closePhotoBtn" class="close-photo-btn">❌ Bezárás</button>
            </div>
        </div>
    </div>

    <!-- New Device Modal -->
    <div id="newDeviceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>➕ Új eszköz hozzáadása</h2>
            <p style="margin-bottom: 15px; color: #666;">Töltsd ki az új eszköz adatait:</p>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ACSG ID:</label>
                <input type="text" id="newDeviceId" class="modal-input" readonly style="background-color: #f0f0f0;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Gyártó / Név:</label>
                <input type="text" id="newDeviceManufacturer" class="modal-input" placeholder="pl: Siemens" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Leírás:</label>
                <input type="text" id="newDeviceDescription" class="modal-input" placeholder="pl: CNC megmunkáló központ">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Modell:</label>
                <input type="text" id="newDeviceModel" class="modal-input" placeholder="pl: DMU 50">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Sorozatszám:</label>
                <input type="text" id="newDeviceSerial" class="modal-input" placeholder="pl: SN123456789">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelNewDevice" class="modal-btn" style="background-color: #6c757d;">❌ Mégse</button>
                <button id="addNewDevice" class="modal-btn">✅ Hozzáad</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="globalStatus" class="status" style="display: none; margin: 20px; border-radius: 10px;"></div>
        <div class="header">
            <h1>🔧 Géplista QR Kód Frissítő</h1>
            <p>Szkennelj QR kódokat és frissítsd a géplistát egyszerűen</p>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h2>📁 Géplista Betöltése</h2>
                <div class="file-upload">
                    <label for="fileInput" class="file-input-wrapper">
                        📂 Excel Fájl Kiválasztása
                        <input type="file" id="fileInput" accept=".xlsx,.xls" />
                    </label>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        💡 <strong>Tipp:</strong> Betölthetsz eredeti géplistát vagy korábban letöltött fájlt is - 
                        automatikusan visszaállítja a beszkennelt elemeket!
                    </div>
                </div>
                
                <div id="fileStatus" class="status info" style="display: none;">
                    Fájl betöltve sikeresen!
                </div>
                
                <h3>📊 Aktuális Géplista</h3>
                <div id="equipmentContainer" style="max-height: 300px; overflow-y: auto;">
                    <p>Tölts be egy Excel fájlt a lista megtekintéséhez</p>
                </div>
            </div>
            
            <div class="panel">
                <h2>📱 QR Kód Beolvasás</h2>
                
                <!-- Kamera szkenner -->
                <div class="scan-section">
                    <h3>📷 Kamerás Szkenner (HTTPS szükséges)</h3>
                    <div class="controls">
                        <button id="startScan" class="btn">📷 Szkenner Indítása</button>
                        <button id="stopScan" class="btn secondary" disabled>⏹️ Szkenner Leállítása</button>
                    </div>
                    <video id="video" style="display: none;"></video>
                </div>

                <!-- Manuális bevitel -->
                <div class="scan-section" style="margin-top: 25px;">
                    <h3>✏️ Manuális ACSG ID Bevitel</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="manualInput" placeholder="Írj be ACSG ID-t (pl: AU2219)" 
                               style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #3498db; border-radius: 25px; font-size: 1em;">
                        <button id="addManual" class="btn">➕ Hozzáadás</button>
                    </div>
                </div>

                <!-- Kép feltöltéses QR olvasás -->
                <div class="scan-section" style="margin-top: 25px;">
                    <h3>🖼️ QR Kép Feltöltése</h3>
                    <label for="qrImageInput" class="file-input-wrapper" style="display: inline-block; margin: 0;">
                        📸 QR Kép Kiválasztása
                        <input type="file" id="qrImageInput" accept="image/*" />
                    </label>
                    <div id="imagePreview" style="margin-top: 15px; display: none;">
                        <img id="previewImg" style="max-width: 200px; border-radius: 10px; border: 2px solid #3498db;">
                    </div>
                </div>
                
                <div id="scanStatus" class="status info" style="display: none;">
                    Válassz egy módszert a QR kódok beolvasásához
                </div>
                
                <h3>✅ Beszkennelt Elemek</h3>
                <div id="scannedList" class="scanned-list">
                    <p style="text-align: center; color: #666; font-style: italic;">
                        Még nem szkenneltél be egyetlen elemet sem
                    </p>
                </div>
            </div>
        </div>
        
            <div class="panel" style="margin: 30px; margin-top: 0;">
            <h2>💾 Frissített Lista Letöltése</h2>
            <p style="margin-bottom: 15px; color: #666;">
                A letöltött fájl tartalmazza az összes beszkennelt információt. 
                Később visszatöltve folytathatod ugyanott, ahol abbahagytad! 🔄
            </p>
            <div class="controls">
                <button id="downloadExcel" class="btn">⬇️ Excel Letöltése</button>
                <button id="clearScanned" class="btn secondary">🗑️ Beszkennelt Lista Törlése</button>
            </div>
            <div id="downloadStatus" class="status info" style="display: none;">
                Kattints a "Excel Letöltése" gombra a frissített fájl letöltéséhez
            </div>
        </div>
    </div>

    <script>
        let equipmentData = [];
        let scannedItems = [];
        let qrScanner = null;
        let isScanning = false;
        let userNameCode = '';

        // DOM elemek
        const fileInput = document.getElementById('fileInput');
        const startScanBtn = document.getElementById('startScan');
        const stopScanBtn = document.getElementById('stopScan');
        const video = document.getElementById('video');
        const manualInput = document.getElementById('manualInput');
        const addManualBtn = document.getElementById('addManual');
        const qrImageInput = document.getElementById('qrImageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const equipmentContainer = document.getElementById('equipmentContainer');
        const scannedList = document.getElementById('scannedList');
        const downloadExcelBtn = document.getElementById('downloadExcel');
        const clearScannedBtn = document.getElementById('clearScanned');

        // Modal elemek
        const nameCodeModal = document.getElementById('nameCodeModal');
        const nameCodeInput = document.getElementById('nameCodeInput');
        const confirmNameCodeBtn = document.getElementById('confirmNameCode');

        // Photo capture elemek
        const photoModal = document.getElementById('photoModal');
        const photoVideo = document.getElementById('photoVideo');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const closePhotoBtn = document.getElementById('closePhotoBtn');
        const photoItemName = document.getElementById('photoItemName');

        // Státusz elemek
        const globalStatus = document.getElementById('globalStatus');
        const fileStatus = document.getElementById('fileStatus');
        const scanStatus = document.getElementById('scanStatus');
        const downloadStatus = document.getElementById('downloadStatus');

        // Event listener-ek
        fileInput.addEventListener('change', handleFileLoad);
        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);
        addManualBtn.addEventListener('click', addManualCode);
        manualInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualCode();
            }
        });
        qrImageInput.addEventListener('change', handleImageUpload);
        downloadExcelBtn.addEventListener('click', downloadExcel);
        clearScannedBtn.addEventListener('click', clearScanned);

        // Modal event listener-ek
        nameCodeInput.addEventListener('input', validateNameCode);
        nameCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !confirmNameCodeBtn.disabled) {
                confirmNameCode();
            }
        });
        confirmNameCodeBtn.addEventListener('click', confirmNameCode);

        // Photo capture event listener-ek
        capturePhotoBtn.addEventListener('click', capturePhoto);
        closePhotoBtn.addEventListener('click', closePhotoModal);

        // Névkód modal kezelő függvények
        function validateNameCode() {
            const code = nameCodeInput.value.trim().toUpperCase();
            confirmNameCodeBtn.disabled = code.length < 2;
            nameCodeInput.value = code;
        }

        function confirmNameCode() {
            const code = nameCodeInput.value.trim().toUpperCase();
            if (code.length >= 2) {
                userNameCode = code;
                nameCodeModal.style.display = 'none';
                showGlobalInfo(`📝 Névkód beállítva: ${userNameCode}`);
            }
        }

        function showNameCodeModal() {
            nameCodeModal.style.display = 'block';
            nameCodeInput.focus();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Fejléc elemzése - ellenőrizzük hogy ez egy korábban exportált fájl-e
                    const headers = jsonData[0];
                    const hasScannedColumn = headers.some(header => 
                        header && header.toString().toLowerCase().includes('scanned')
                    );
                    const hasScannedAtColumn = headers.some(header => 
                        header && (header.toString().toLowerCase().includes('scanned at') || 
                                  header.toString().toLowerCase().includes('scanned_at'))
                    );
                    const hasSourceColumn = headers.some(header =>
                        header && header.toString().toLowerCase().includes('source')
                    );
                    const hasNameCodeColumn = headers.some(header =>
                        header && header.toString().toLowerCase().includes('name code')
                    );
                    const hasActiveColumn = headers.some(header =>
                        header && header.toString().toLowerCase().includes('active')
                    );

                    let scannedColumnIndex = -1;
                    let scannedAtColumnIndex = -1;
                    let sourceColumnIndex = -1;
                    let nameCodeColumnIndex = -1;
                    let activeColumnIndex = -1;

                    if (hasScannedColumn) {
                        scannedColumnIndex = headers.findIndex(header => 
                            header && header.toString().toLowerCase().includes('scanned') && 
                            !header.toString().toLowerCase().includes('at')
                        );
                    }

                    if (hasScannedAtColumn) {
                        scannedAtColumnIndex = headers.findIndex(header => 
                            header && (header.toString().toLowerCase().includes('scanned at') || 
                                      header.toString().toLowerCase().includes('scanned_at'))
                        );
                    }

                    if (hasSourceColumn) {
                        sourceColumnIndex = headers.findIndex(header =>
                            header && header.toString().toLowerCase().includes('source')
                        );
                    }

                    if (hasNameCodeColumn) {
                        nameCodeColumnIndex = headers.findIndex(header =>
                            header && header.toString().toLowerCase().includes('name code')
                        );
                    }

                    if (hasActiveColumn) {
                        activeColumnIndex = headers.findIndex(header =>
                            header && header.toString().toLowerCase().includes('active')
                        );
                    }

                    // Adatok feldolgozása
                    equipmentData = [];
                    scannedItems = []; // Beszkennelt lista törlése
                    
                    let restoredCount = 0;

                    jsonData.slice(1).forEach((row, index) => {
                        const item = {
                            id: index + 1,
                            manufacturer: row[0] || '',
                            description: row[1] || '',
                            model: row[2] || '',
                            serialNumber: row[3] || '',
                            acsgId: row[4] || '',
                            scanned: false,
                            scannedAt: null,
                            source: null,
                            nameCode: null,
                            active: true, // Default to active
                            hasPhoto: false // Default no photo
                        };

                        // Ha van Scanned oszlop, akkor visszaállítjuk az állapotot
                        if (scannedColumnIndex !== -1 && row[scannedColumnIndex]) {
                            const scannedValue = row[scannedColumnIndex].toString().toLowerCase();
                            if (scannedValue === 'yes' || scannedValue === 'igen' || scannedValue === '1' || scannedValue === 'true') {
                                item.scanned = true;
                                restoredCount++;
                                
                                // Scanned At visszaállítása
                                if (scannedAtColumnIndex !== -1 && row[scannedAtColumnIndex]) {
                                    item.scannedAt = row[scannedAtColumnIndex];
                                }
                                
                                // Source visszaállítása
                                if (sourceColumnIndex !== -1 && row[sourceColumnIndex]) {
                                    item.source = row[sourceColumnIndex];
                                } else {
                                    item.source = 'Korábban rögzítve';
                                }

                                // Name Code visszaállítása
                                if (nameCodeColumnIndex !== -1 && row[nameCodeColumnIndex]) {
                                    item.nameCode = row[nameCodeColumnIndex];
                                }

                                // Hozzáadás a beszkennelt listához
                                scannedItems.push({...item});
                            }
                        }

                        // Active állapot visszaállítása (minden itemre, nemcsak a scannedre)
                        if (activeColumnIndex !== -1 && row[activeColumnIndex]) {
                            const activeValue = row[activeColumnIndex].toString().toLowerCase();
                            item.active = (activeValue === 'yes' || activeValue === 'igen' || activeValue === '1' || activeValue === 'true');
                        }

                        equipmentData.push(item);
                    });

                    displayEquipmentList();
                    displayScannedList();

                    // Fókusz visszaállítása a manuális beviteli mezőre
                    setTimeout(() => {
                        manualInput.focus();
                    }, 100);

                    let statusMessage = `${equipmentData.length} gép betöltve sikeresen!`;
                    if (restoredCount > 0) {
                        statusMessage += ` 🔄 ${restoredCount} korábban beszkennelt elem visszaállítva!`;
                        showStatus(fileStatus, statusMessage, 'success');
                        showStatus(scanStatus, `✅ Folytathatod a munkát! ${restoredCount} elem már be volt szkennelve.`, 'success');
                    } else {
                        showStatus(fileStatus, statusMessage, 'success');
                    }
                    
                } catch (error) {
                    showGlobalError('Hiba a fájl betöltésekor: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayEquipmentList() {
            if (equipmentData.length === 0) {
                equipmentContainer.innerHTML = '<p>Nincs betöltött adat</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'equipment-table';
            
            // Fejléc
            const headerRow = document.createElement('tr');
            ['Gyártó', 'Modell', 'Leírás', 'ACSG ID', 'Státusz'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Adatok
            equipmentData.forEach(item => {
                const row = document.createElement('tr');
                
                [item.manufacturer, item.model, item.description, item.acsgId].forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    row.appendChild(td);
                });

                const statusTd = document.createElement('td');
                if (item.scanned) {
                    statusTd.innerHTML = `<span style="color: green; font-weight: bold;">✅ Beszkennelve</span>
                                        <br><small style="color: #666;">${item.scannedAt || 'Ismeretlen időpont'}</small>`;
                } else {
                    statusTd.innerHTML = '<span style="color: #999;">⏳ Várakozik</span>';
                }
                row.appendChild(statusTd);

                if (item.scanned) {
                    row.style.backgroundColor = '#d4edda';
                }

                table.appendChild(row);
            });

            equipmentContainer.innerHTML = '';
            equipmentContainer.appendChild(table);
        }

        // QR szkenner funkciók
        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);

        async function startScanning() {
            try {
                // HTTPS ellenőrzés
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    showGlobalError('⚠️ HTTPS szükséges a kamera használatához! Használd a manuális bevitelt vagy kép feltöltést.');
                    return;
                }

                if (!QrScanner.hasCamera()) {
                    showGlobalError('Nincs elérhető kamera! Használd a manuális bevitelt.');
                    return;
                }

                video.style.display = 'block';
                qrScanner = new QrScanner(video, handleQrResult, {
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                });

                await qrScanner.start();
                isScanning = true;
                startScanBtn.disabled = true;
                stopScanBtn.disabled = false;
                showStatus(scanStatus, 'Szkenner aktív - irányítsd a kamerát egy QR kódra', 'info');

            } catch (error) {
                showGlobalError('Hiba a szkenner indításakor: ' + error.message + '. Használd a manuális bevitelt!');
            }
        }

        function stopScanning() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner = null;
            }
            video.style.display = 'none';
            isScanning = false;
            startScanBtn.disabled = false;
            stopScanBtn.disabled = true;
            showStatus(scanStatus, 'Szkenner leállítva', 'success');
        }

        function handleQrResult(result) {
            const scannedCode = result.data;
            processScannedCode(scannedCode, 'Kamerás szkenner');
        }

        // Manuális kód hozzáadása
        function addManualCode() {
            const code = manualInput.value.trim().toUpperCase().replace(/Ö/g, '0');
            if (!code) {
                showStatus(scanStatus, 'Kérlek írj be egy ACSG ID-t!', 'error');
                manualInput.focus(); // Fókusz visszaadása
                return;
            }

            processScannedCode(code, 'Manuális bevitel');
            manualInput.value = '';
            manualInput.focus(); // Fókusz visszaadása a következő beolvasáshoz
        }

        // Kép feltöltés és QR olvasás
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Kép előnézet
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                
                // QR kód olvasás a képből
                QrScanner.scanImage(file, { returnDetailedScanResult: true })
                    .then(result => {
                        processScannedCode(result.data, 'Kép feltöltés');
                        showStatus(scanStatus, `✅ QR kód sikeresen beolvasva a képből!`, 'success');
                    })
                    .catch(error => {
                        showStatus(scanStatus, '❌ Nem sikerült QR kódot találni a képben. Próbáld a manuális bevitelt!', 'error');
                        console.log('QR olvasási hiba:', error);
                    });
            };
            reader.readAsDataURL(file);
        }

        // Központi kód feldolgozás
        function processScannedCode(scannedCode, source) {
            // Keresés az equipment listában
            const foundItem = equipmentData.find(item =>
                item.acsgId.toUpperCase() === scannedCode.toUpperCase()
            );

            if (foundItem) {
                if (!foundItem.scanned) {
                    foundItem.scanned = true;
                    foundItem.scannedAt = new Date().toLocaleString('hu-HU');
                    foundItem.source = source;
                    foundItem.nameCode = userNameCode;
                    foundItem.active = true; // Default to active
                    foundItem.hasPhoto = false; // Default no photo

                    // Hozzáadás a beszkennelt listához
                    if (!scannedItems.find(item => item.acsgId.toUpperCase() === scannedCode.toUpperCase())) {
                        scannedItems.push({...foundItem});
                        displayScannedList();
                        displayEquipmentList(); // Lista frissítése
                        showStatus(scanStatus, `✅ Sikeres szkennelés (${source}): ${foundItem.manufacturer} ${foundItem.model}`, 'success');
                    } else {
                        showStatus(scanStatus, `⚠️ Ez az elem már be volt szkennelve: ${foundItem.manufacturer} ${foundItem.model}`, 'info');
                    }
                } else {
                    showStatus(scanStatus, `⚠️ Ez az elem már be volt szkennelve korábban`, 'info');
                }
            } else {
                // Ismeretlen ID esetén felhasználó választása
                if (confirm(`❓ Ismeretlen ACSG ID: ${scannedCode}\n\nSzeretnéd felvenni új eszközként?`)) {
                    showNewDeviceModal(scannedCode);
                } else {
                    showStatus(scanStatus, `❌ Ismeretlen ACSG ID: ${scannedCode}. Ellenőrizd a kódot!`, 'error');
                }
            }
        }

        function displayScannedList() {
            if (scannedItems.length === 0) {
                scannedList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">Még nem szkenneltél be egyetlen elemet sem</p>';
                return;
            }

            const container = document.createElement('div');
            scannedItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'scanned-item';
                const isActive = item.active !== false; // Default to true if not set
                itemDiv.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${item.manufacturer} ${item.model}</strong><br>
                        ${item.description ? `<small>Leírás: ${item.description}</small><br>` : ''}
                        <small>ACSG ID: ${item.acsgId}</small><br>
                        ${item.serialNumber ? `<small>Sorozatszám: ${item.serialNumber}</small><br>` : ''}
                        <small>Forrás: ${item.source || 'Ismeretlen'}</small><br>
                        <small>Időpont: ${item.scannedAt}</small>
                        <div class="toggle-container">
                            <span class="toggle-label ${isActive ? 'active' : 'inactive'}" id="toggleLabel${index}">
                                ${isActive ? 'Aktív' : 'Inaktív'}
                            </span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleActiveState(${index})" id="toggle${index}">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                        <button onclick="takePhoto(${index})" class="photo-btn" title="Fotó készítése">
                            📸 ${item.hasPhoto ? '✅' : 'Fotó'}
                        </button>
                        <button onclick="removeScannedItem(${index})" class="btn secondary" style="padding: 5px 10px; font-size: 0.8em;">❌</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            scannedList.innerHTML = '';
            scannedList.appendChild(container);
        }

        // Photo capture változók
        let currentPhotoItemIndex = -1;
        let photoStream = null;

        // Fotó készítése egy elemről
        function takePhoto(index) {
            if (index >= 0 && index < scannedItems.length) {
                currentPhotoItemIndex = index;
                const item = scannedItems[index];
                photoItemName.textContent = `${item.manufacturer} ${item.model} (${item.acsgId})`;
                showPhotoModal();
            }
        }

        // Photo modal megjelenítése és kamera indítása
        async function showPhotoModal() {
            photoModal.style.display = 'block';

            try {
                // Kamera stream indítása
                photoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // Hátsó kamera előnyben részesítése
                    }
                });
                photoVideo.srcObject = photoStream;
                capturePhotoBtn.disabled = false;
            } catch (error) {
                console.error('Kamera hozzáférési hiba:', error);
                showStatus(scanStatus, 'Kamera hozzáférési hiba! Ellenőrizd az engedélyeket.', 'error');
                closePhotoModal();
            }
        }

        // Photo modal bezárása
        function closePhotoModal() {
            photoModal.style.display = 'none';

            // Kamera stream leállítása
            if (photoStream) {
                photoStream.getTracks().forEach(track => track.stop());
                photoStream = null;
            }

            photoVideo.srcObject = null;
            capturePhotoBtn.disabled = true;
            currentPhotoItemIndex = -1;
        }

        // Fotó készítése és letöltése
        function capturePhoto() {
            if (currentPhotoItemIndex < 0 || !photoStream) return;

            const item = scannedItems[currentPhotoItemIndex];

            // Canvas beállítása a videó méretéhez
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = photoVideo.videoWidth;
            photoCanvas.height = photoVideo.videoHeight;

            // Videó frame rögzítése canvas-ra
            context.drawImage(photoVideo, 0, 0);

            // Canvas konvertálása blob-ba
            photoCanvas.toBlob(function(blob) {
                // Letöltés indítása
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${item.acsgId}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Fotó státusz frissítése
                item.hasPhoto = true;
                const equipmentItem = equipmentData.find(eq => eq.acsgId === item.acsgId);
                if (equipmentItem) {
                    equipmentItem.hasPhoto = true;
                }

                // Lista frissítése hogy megjelenjen a fotó indikátor
                displayScannedList();

                showStatus(scanStatus, `📸 Fotó készítve és letöltve: ${item.acsgId}.jpg`, 'success');
                closePhotoModal();
            }, 'image/jpeg', 0.8);
        }

        // Aktív/Inaktív állapot váltása
        function toggleActiveState(index) {
            if (index >= 0 && index < scannedItems.length) {
                const item = scannedItems[index];
                item.active = !item.active;

                // Frissítés a fő equipment listában is
                const equipmentItem = equipmentData.find(eq => eq.acsgId === item.acsgId);
                if (equipmentItem) {
                    equipmentItem.active = item.active;
                }

                // Label frissítése
                const label = document.getElementById(`toggleLabel${index}`);
                if (label) {
                    label.textContent = item.active ? 'Aktív' : 'Inaktív';
                    label.className = `toggle-label ${item.active ? 'active' : 'inactive'}`;
                }

                showStatus(scanStatus, `${item.manufacturer} ${item.model} állapota: ${item.active ? 'Aktív' : 'Inaktív'}`, 'info');
            }
        }

        function removeScannedItem(index) {
            const item = scannedItems[index];
            
            // Jelölés visszavonása az eredeti listában
            const originalItem = equipmentData.find(eq => eq.acsgId === item.acsgId);
            if (originalItem) {
                originalItem.scanned = false;
                originalItem.scannedAt = null;
            }
            
            scannedItems.splice(index, 1);
            displayScannedList();
            displayEquipmentList();
        }

        // Letöltés és törlés event listener-ek
        downloadExcelBtn.addEventListener('click', downloadExcel);
        clearScannedBtn.addEventListener('click', clearScanned);

        function downloadExcel() {
            if (equipmentData.length === 0) {
                showStatus(downloadStatus, 'Nincs adat a letöltéshez!', 'error');
                return;
            }

            try {
                // Új munkafüzet létrehozása
                const wb = XLSX.utils.book_new();
                
                // Adatok előkészítése
                const wsData = [
                    ['Manufacturer', 'Description', 'Model', 'Serial Number', 'ACSG ID (ABAS ID)', 'Scanned', 'Scanned At', 'Source', 'Name Code', 'Active']
                ];

                equipmentData.forEach(item => {
                    wsData.push([
                        item.manufacturer,
                        item.description,
                        item.model,
                        item.serialNumber || '',
                        item.acsgId,
                        item.scanned ? 'Yes' : 'No',
                        item.scannedAt || '',
                        item.source || '',
                        item.nameCode || '',
                        item.scanned ? (item.active !== false ? 'Yes' : 'No') : '' // Only show active state for scanned items
                    ]);
                });

                // Munkalap létrehozása
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'upkeep-assets');

                // Fájl letöltése
                const fileName = `Géplista_frissítve_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus(downloadStatus, `Excel fájl letöltve: ${fileName}`, 'success');
                
            } catch (error) {
                showGlobalError('Hiba a letöltés során: ' + error.message);
            }
        }

        function clearScanned() {
            if (confirm('Biztosan törölni szeretnéd az összes beszkennelt elemet? Ez a művelet nem vonható vissza.')) {
                scannedItems = [];
                equipmentData.forEach(item => {
                    item.scanned = false;
                    item.scannedAt = null;
                    item.source = null;
                });
                displayScannedList();
                displayEquipmentList();
                showStatus(downloadStatus, 'Beszkennelt lista törölve', 'success');
            }
        }

        function showStatus(element, message, type, isGlobal = false) {
            // Ha globális státusz, akkor a tetejére helyezzük
            const targetElement = isGlobal ? globalStatus : element;

            targetElement.textContent = message;
            targetElement.className = `status ${type}`;
            targetElement.style.display = 'block';

            // Globális üzenetnél görgessünk fel
            if (isGlobal) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            setTimeout(() => {
                targetElement.style.display = 'none';
            }, 5000);
        }

        // Globális hibaüzenet megjelenítés
        function showGlobalError(message) {
            showStatus(null, message, 'error', true);
        }

        function showGlobalSuccess(message) {
            showStatus(null, message, 'success', true);
        }

        function showGlobalInfo(message) {
            showStatus(null, message, 'info', true);
        }

        // Oldal betöltéskor
        document.addEventListener('DOMContentLoaded', function() {
            // Névkód bekérése modal megjelenítése
            showNameCodeModal();

            showStatus(scanStatus, 'Válassz egy módszert a QR kódok beolvasásához! 📱💻📷', 'info');

            // Fókusz a manuális beviteli mezőre (csak ha nincs aktív modal)
            if (nameCodeModal.style.display === 'none') {
                manualInput.focus();
            }

            // HTTPS figyelmeztetés megjelenítése ha szükséges
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                setTimeout(() => {
                    showStatus(scanStatus, '💡 Tipp: HTTPS-en a kamerás szkenner is használható!', 'info');
                }, 3000);
            }

            // PWA telepítés támogatása
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Telepítés gomb megjelenítése
                const installBtn = document.createElement('button');
                installBtn.className = 'btn';
                installBtn.innerHTML = '📱 Telepítés Android App-ként';
                installBtn.style.position = 'fixed';
                installBtn.style.bottom = '20px';
                installBtn.style.right = '20px';
                installBtn.style.zIndex = '1000';
                installBtn.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
                
                installBtn.onclick = async () => {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('PWA telepítve');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                };
                
                document.body.appendChild(installBtn);
            });
        });

        // New Device Modal functionality
        const newDeviceModal = document.getElementById('newDeviceModal');
        const newDeviceIdInput = document.getElementById('newDeviceId');
        const newDeviceManufacturerInput = document.getElementById('newDeviceManufacturer');
        const newDeviceDescriptionInput = document.getElementById('newDeviceDescription');
        const newDeviceModelInput = document.getElementById('newDeviceModel');
        const newDeviceSerialInput = document.getElementById('newDeviceSerial');
        const cancelNewDeviceBtn = document.getElementById('cancelNewDevice');
        const addNewDeviceBtn = document.getElementById('addNewDevice');

        function showNewDeviceModal(scannedCode) {
            newDeviceIdInput.value = scannedCode;
            newDeviceManufacturerInput.value = '';
            newDeviceDescriptionInput.value = '';
            newDeviceModelInput.value = '';
            newDeviceSerialInput.value = '';
            newDeviceModal.style.display = 'flex';
            setTimeout(() => {
                newDeviceManufacturerInput.focus();
            }, 100);
        }

        function closeNewDeviceModal() {
            newDeviceModal.style.display = 'none';
        }

        function addNewDevice() {
            const manufacturer = newDeviceManufacturerInput.value.trim();
            const description = newDeviceDescriptionInput.value.trim();
            const model = newDeviceModelInput.value.trim();
            const serialNumber = newDeviceSerialInput.value.trim();
            const acsgId = newDeviceIdInput.value.trim();

            if (!manufacturer) {
                alert('A gyártó/név mező kitöltése kötelező!');
                newDeviceManufacturerInput.focus();
                return;
            }

            if (!acsgId) {
                alert('ACSG ID hiányzik!');
                return;
            }

            // Check if ACSG ID already exists
            const existingItem = equipmentData.find(item =>
                item.acsgId.toUpperCase() === acsgId.toUpperCase()
            );

            if (existingItem) {
                alert('Ez az ACSG ID már létezik a listában!');
                return;
            }

            // Create new device item
            const newItem = {
                id: equipmentData.length + 1,
                manufacturer: manufacturer,
                description: description,
                model: model,
                serialNumber: serialNumber,
                acsgId: acsgId,
                scanned: true, // Automatically mark as scanned
                scannedAt: new Date().toLocaleString('hu-HU'),
                source: 'Új eszköz hozzáadása',
                nameCode: userNameCode,
                active: true,
                hasPhoto: false
            };

            // Add to equipment data
            equipmentData.push(newItem);

            // Add to scanned items
            scannedItems.push({...newItem});

            // Update displays
            displayEquipmentList();
            displayScannedList();

            // Close modal
            closeNewDeviceModal();

            // Show success message
            showStatus(scanStatus, `✅ Új eszköz hozzáadva és beszkennelve: ${manufacturer} ${model}`, 'success');
        }

        // Event listeners for new device modal
        cancelNewDeviceBtn.addEventListener('click', closeNewDeviceModal);
        addNewDeviceBtn.addEventListener('click', addNewDevice);

        // Close modal when clicking outside
        newDeviceModal.addEventListener('click', function(e) {
            if (e.target === newDeviceModal) {
                closeNewDeviceModal();
            }
        });

        // Handle Enter key in form fields
        [newDeviceManufacturerInput, newDeviceDescriptionInput, newDeviceModelInput, newDeviceSerialInput].forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewDevice();
                }
            });
        });
    </script>
</body>
</html>